<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Chi ti·∫øt s·∫£n ph·∫©m</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="container mt-5">
  <h2>üì¶ Chi ti·∫øt s·∫£n ph·∫©m</h2>
  <div id="productInfo" class="mt-4"></div>

  <div id="bidFormArea" class="mt-4"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const productId = params.get("id");
    const token = localStorage.getItem("access_token");

    async function loadProduct() {
      const res = await fetch(`https://vietdaugia-api.onrender.com/products/${productId}`);
      const p = await res.json();

      const html = `
        <div class="row">
          <div class="col-md-6">
            <img src="${p.image || 'https://via.placeholder.com/500x300?text=No+Image'}" class="img-fluid" />
          </div>
          <div class="col-md-6">
            <h3>${p.name}</h3>
            <p>${p.description || "Kh√¥ng c√≥ m√¥ t·∫£"}</p>
            <p>Gi√° kh·ªüi ƒëi·ªÉm: <strong>${p.startingPrice?.toLocaleString()}ƒë</strong></p>
            <p>Gi√° hi·ªán t·∫°i: <strong>${p.currentPrice?.toLocaleString()}ƒë</strong></p>
            <p>Ng∆∞·ªùi b√°n: ${p.seller?.email || "·∫®n"}</p>
          </div>
        </div>
      `;
      document.getElementById("productInfo").innerHTML = html;

      showBidForm(p.currentPrice);
    }

    function showBidForm(currentPrice) {
      if (!token) {
        document.getElementById("bidFormArea").innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t gi√°.</div>`;
        return;
      }

      document.getElementById("bidFormArea").innerHTML = `
        <h4>üí∞ ƒê·∫∑t gi√°</h4>
        <form id="bidForm">
          <div class="mb-3">
            <label for="bid" class="form-label">Gi√° b·∫°n mu·ªën ƒë·∫∑t (t·ªëi thi·ªÉu ${currentPrice + 1}ƒë):</label>
            <input type="number" id="bid" class="form-control" required min="${currentPrice + 1}" />
          </div>
          <button class="btn btn-success">ƒê·∫∑t gi√°</button>
        </form>
        <p class="mt-3" id="msg"></p>
      `;

      const bidForm = document.getElementById("bidForm");
      bidForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const bidValue = parseInt(document.getElementById("bid").value);

        const res = await fetch(`https://vietdaugia-api.onrender.com/products/${productId}/bid`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ bid: bidValue }),
        });

        const msgEl = document.getElementById("msg");
        if (res.ok) {
          msgEl.innerHTML = `<span class="text-success">‚úÖ ƒê·∫∑t gi√° th√†nh c√¥ng!</span>`;
          loadProduct();
        } else {
          const err = await res.text();
          msgEl.innerHTML = `<span class="text-danger">‚ùå L·ªói: ${err}</span>`;
        }
      });
    }

    loadProduct();
  </script>
</body>
</html>
