<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="container mt-5">
  <h2>üõ°Ô∏è Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h2>
  <div id="userInfo" class="mb-3"></div>
  <div id="userTableArea"></div>

  <script>
    const token = localStorage.getItem("access_token");
    const userEmail = localStorage.getItem("user_email");
    const userRole = localStorage.getItem("user_role");
    const userInfoEl = document.getElementById("userInfo");
    const userTableArea = document.getElementById("userTableArea");

    if (!token || userRole !== "admin") {
      userInfoEl.innerHTML = `
        <div class="alert alert-danger">
          ‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.<br/>
          Ch·ªâ t√†i kho·∫£n <strong>admin</strong> m·ªõi ƒë∆∞·ª£c ph√©p.
        </div>
      `;
    } else {
      userInfoEl.innerHTML = `
        <div class="alert alert-success">
          üëã Xin ch√†o <strong>${userEmail}</strong> (${userRole})
        </div>
      `;

      // G·ª≠i request l·∫•y danh s√°ch user
      fetch("https://vietdaugia-api.onrender.com/users", {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      })
      .then((res) => res.json())
      .then((data) => {
        const rows = data.map((u, index) => `
          <tr>
            <td>${index + 1}</td>
            <td>${u.email}</td>
            <td><span id="role-${u._id}">${u.role}</span></td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="changeRole('${u._id}', '${u.role}')">
                ƒê·ªïi vai tr√≤
              </button>
            </td>
          </tr>
        `).join("");

        userTableArea.innerHTML = `
          <table class="table table-striped mt-3">
            <thead>
              <tr>
                <th>#</th>
                <th>Email</th>
                <th>Vai tr√≤</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      })
      .catch((err) => {
        userTableArea.innerHTML = `
          <div class="alert alert-danger">‚ùå L·ªói t·∫£i danh s√°ch: ${err.message}</div>
        `;
      });
    }

    // H√†m ƒë·ªïi vai tr√≤
    async function changeRole(userId, currentRole) {
      const token = localStorage.getItem("access_token");
      const newRole = currentRole === "buyer" ? "seller" : "buyer";

      const confirmChange = confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒë·ªïi vai tr√≤ t·ª´ "${currentRole}" sang "${newRole}"?`);
      if (!confirmChange) return;

      const res = await fetch(`https://vietdaugia-api.onrender.com/users/${userId}/role`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ role: newRole }),
      });

      if (res.ok) {
        document.getElementById(`role-${userId}`).innerText = newRole;
        alert("‚úÖ C·∫≠p nh·∫≠t vai tr√≤ th√†nh c√¥ng!");
      } else {
        const err = await res.text();
        alert("‚ùå L·ªói c·∫≠p nh·∫≠t: " + err);
      }
    }
  </script>
</body>
</html>
