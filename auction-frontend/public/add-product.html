<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Th√™m s·∫£n ph·∫©m</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
</head>
<body class="container py-5">
  <h2>üõí Th√™m s·∫£n ph·∫©m m·ªõi</h2>
  <div id="message"></div>

  <form id="addForm" class="mt-4">
    <div class="mb-3">
      <label class="form-label">T√™n s·∫£n ph·∫©m:</label>
      <input type="text" class="form-control" id="name" required />
    </div>

    <div class="mb-3">
      <label class="form-label">M√¥ t·∫£:</label>
      <textarea class="form-control" id="description" rows="3"></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Danh m·ª•c:</label>
      <select class="form-select" id="category" required>
        <option>ƒê·ªì ƒëi·ªán t·ª≠, AV & M√°y ·∫£nh</option>
        <option>ƒê·ªìng h·ªì & Ph·ª• ki·ªán</option>
        <option>ƒêi·ªán t·ª≠ vƒÉn ph√≤ng</option>
        <option>Nh√† c·ª≠a ƒë·ªùi s·ªëng</option>
        <option>Th·ªÉ thao & Gi·∫£i tr√≠</option>
        <option>VƒÉn h√≥a ph·∫©m</option>
        <option>Th·ªùi trang - Ph·ª• ki·ªán</option>
        <option>√Çm nh·∫°c</option>
        <option>S∆∞u t·∫ßm ƒë·ªì c·ªï</option>
        <option>ƒê·ªì tr·∫ª em</option>
        <option>S√°ch, VPP & Qu√† t·∫∑ng</option>
        <option>S·ª©c kh·ªèe & L√†m ƒë·∫πp</option>
        <option>S·ªü th√≠ch & VƒÉn ho√°</option>
        <option>√î t√¥, Xe m√°y, Xe ƒë·∫°p</option>
        <option>Phim, video</option>
        <option>ƒê·ªì ch∆°i & Tr√≤ ch∆°i</option>
        <option>S√°ch & T·∫°p ch√≠</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Gi√° kh·ªüi ƒëi·ªÉm (VNƒê):</label>
      <input type="number" class="form-control" id="startingPrice" required />
    </div>

    <div class="mb-3">
      <label class="form-label">Th·ªùi gian k·∫øt th√∫c:</label>
      <input type="datetime-local" class="form-control" id="endTime" required />
    </div>

    <div class="mb-3">
      <label class="form-label">·∫¢nh s·∫£n ph·∫©m:</label>
      <input type="file" class="form-control" id="imageInput" accept="image/*" />
      <div class="mt-2">
        <img id="imagePreview" style="max-width: 100%; max-height: 300px; display: none;" />
      </div>
    </div>

    <button type="submit" class="btn btn-primary">ƒêƒÉng s·∫£n ph·∫©m</button>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <script>
    const form = document.getElementById("addForm");
    const token = localStorage.getItem("access_token");
    const role = localStorage.getItem("user_role");
    const msgEl = document.getElementById("message");

    const imageInput = document.getElementById("imageInput");
    const imagePreview = document.getElementById("imagePreview");
    let cropper;

    if (!token || role !== "seller") {
      msgEl.innerHTML = `
        <div class="alert alert-danger mt-3">
          ‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y (ch·ªâ seller ƒë∆∞·ª£c ph√©p).
        </div>`;
      form.style.display = "none";
    }

    imageInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      imagePreview.src = url;
      imagePreview.style.display = "block";

      if (cropper) cropper.destroy();
      cropper = new Cropper(imagePreview, {
        aspectRatio: 1,
        viewMode: 1,
        autoCropArea: 1,
      });
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const canvas = cropper?.getCroppedCanvas();
      const base64Image = canvas?.toDataURL("image/jpeg");

      const product = {
        name: document.getElementById("name").value,
        description: document.getElementById("description").value,
        category: document.getElementById("category").value,
        startingPrice: +document.getElementById("startingPrice").value,
        endTime: new Date(document.getElementById("endTime").value).toISOString(),
        image: base64Image,
      };

      const res = await fetch("https://vietdaugia-api.onrender.com/products", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(product),
      });

      if (res.ok) {
        msgEl.innerHTML = `<div class="alert alert-success mt-3">‚úÖ ƒêƒÉng s·∫£n ph·∫©m th√†nh c√¥ng!</div>`;
        form.reset();
        imagePreview.style.display = "none";
        cropper?.destroy();
      } else {
        const err = await res.text();
        msgEl.innerHTML = `<div class="alert alert-danger mt-3">‚ùå L·ªói: ${err}</div>`;
      }
    });
  </script>
</body>
</html>
