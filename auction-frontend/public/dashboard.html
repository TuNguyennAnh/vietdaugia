<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Trang cÃ¡ nhÃ¢n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="container mt-5">
  <h2>ğŸ“Š Dashboard ngÆ°á»i dÃ¹ng</h2>
  <div id="userInfo" class="mb-3"></div>
  <div id="dashboardContent"></div>

  <script>
    const token = localStorage.getItem("access_token");
    const userEmail = localStorage.getItem("user_email");
    const userRole = localStorage.getItem("user_role");

    const userInfoEl = document.getElementById("userInfo");
    const dashboardContent = document.getElementById("dashboardContent");

    if (!token || !userRole) {
      userInfoEl.innerHTML = `
        <div class="alert alert-danger">
          âŒ Báº¡n chÆ°a Ä‘Äƒng nháº­p.
        </div>
      `;
    } else {
      userInfoEl.innerHTML = `
        <div class="alert alert-info">
          ğŸ‘¤ Xin chÃ o <strong>${userEmail}</strong> (${userRole})
        </div>
      `;

      if (userRole === 'buyer') {
        dashboardContent.innerHTML = `
          <div class="alert alert-primary">
            ğŸ›ï¸ ÄÃ¢y lÃ  khu vá»±c cá»§a ngÆ°á»i mua. (TÃ­nh nÄƒng theo dÃµi sáº£n pháº©m Ä‘Ã£ Ä‘áº¥u giÃ¡ sáº½ Ä‘Æ°á»£c cáº­p nháº­t sau.)
          </div>
        `;
      }

      if (userRole === 'seller') {
        dashboardContent.innerHTML = `<div class="text-muted">ğŸ”„ Äang táº£i danh sÃ¡ch sáº£n pháº©m...</div>`;

        fetch('https://vietdaugia-api.onrender.com/products', {
          headers: { Authorization: `Bearer ${token}` }
        })
          .then(res => res.json())
          .then(data => {
            const sellerEmail = userEmail;

            const list = data
              .filter(p => p.seller === sellerEmail || p.seller?.email === sellerEmail)
              .map((p, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td>${p.name}</td>
                  <td>${p.currentPrice.toLocaleString()} VNÄ</td>
                  <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p._id}')">
                      ğŸ—‘ï¸ XÃ³a
                    </button>
                  </td>
                </tr>
              `).join("");

            dashboardContent.innerHTML = `
              <h5 class="mt-4">ğŸ›’ Sáº£n pháº©m Ä‘Ã£ Ä‘Äƒng</h5>
              <table class="table table-bordered">
                <thead>
                  <tr><th>#</th><th>TÃªn</th><th>GiÃ¡ hiá»‡n táº¡i</th><th>Thao tÃ¡c</th></tr>
                </thead>
                <tbody>${list || '<tr><td colspan="4">ChÆ°a cÃ³ sáº£n pháº©m nÃ o.</td></tr>'}</tbody>
              </table>
            `;
          })
          .catch(err => {
            dashboardContent.innerHTML = `
              <div class="alert alert-danger">âŒ KhÃ´ng táº£i Ä‘Æ°á»£c danh sÃ¡ch sáº£n pháº©m. ${err.message}</div>
            `;
          });
      }

      if (userRole === 'admin') {
        dashboardContent.innerHTML = `
          <div class="alert alert-warning">
            ğŸ›¡ï¸ Báº¡n lÃ  quáº£n trá»‹ viÃªn. Truy cáº­p <a href="/manage-users.html">Quáº£n lÃ½ ngÆ°á»i dÃ¹ng</a>.
          </div>
        `;
      }
    }

    async function deleteProduct(productId) {
      const confirmDel = confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a sáº£n pháº©m nÃ y?");
      if (!confirmDel) return;

      const res = await fetch(`https://vietdaugia-api.onrender.com/products/${productId}`, {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      if (res.ok) {
        alert("âœ… ÄÃ£ xÃ³a sáº£n pháº©m!");
        location.reload();
      } else {
        const err = await res.text();
        alert("âŒ Lá»—i xÃ³a sáº£n pháº©m: " + err);
      }
    }
  </script>
</body>
</html>
